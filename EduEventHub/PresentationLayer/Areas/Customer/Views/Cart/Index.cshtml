@model IEnumerable<Cart>
@{
    ViewBag.Title = "My Cart";
}

@Html.AntiForgeryToken()

<div class="container" style="margin-top:120px; margin-bottom:50px;">
    <h2 class="text-center mb-4">
        <strong>My</strong> <span style="color: #fd5f17;">Cart</span>
    </h2>

    @if (Model == null || !Model.Any())
    {
        <div class="text-center text-muted">
            <i class="fa fa-shopping-cart fa-3x mb-3"></i>
            <p>Your cart is empty.</p>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var item in Model)
            {
                <div class="col-md-4 mb-4" data-event-id="@item.EventId">
                    <div class="card shadow-sm">
                        <img src="~/@item.Event.ImgPath" class="card-img-top" alt="@item.Event.Title"
                             style="height: 200px; object-fit: cover;" />
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-warning text-dark px-2 py-1">
                                    @item.Event.StartDate.ToString("dd MMM")
                                </span>
                                <button class="btn btn-sm btn-danger delete-cart-item" data-event-id="@item.EventId">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                            <h5 class="card-title">@item.Event.Title</h5>
                            <p class="card-text text-muted">@item.Event.Description</p>

                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">@item.Event.Price.ToString("C")</span>

                               <div class="col-md-4 mb-4 cart-item" data-price="@item.Event.Price">
                                    <div class="input-group input-group-sm" style="width: 110px;">
                                        <button class="btn btn-outline-secondary quantity-btn"
                                                data-event-id="@item.EventId"
                                                data-action="decrement">−</button>

                                        <input type="text" class="form-control text-center qty-input"
                                               id="qty-@item.EventId" value="@item.Count" readonly />

                                        <button class="btn btn-outline-secondary quantity-btn"
                                                data-event-id="@item.EventId"
                                                data-action="increment">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="text-end mt-4">
            <h4>Total: <span class="text-success fw-bold" id="cart-total">
                @Model.Sum(x => x.Event.Price * x.Count).ToString("C")
            </span></h4>
            <a href="/Checkout" class="btn btn-primary mt-2">
                <i class="fa fa-credit-card"></i> Proceed to Checkout
            </a>
        </div>
    }
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        // زر + أو -
        $('.quantity-btn').on('click', function (e) {
            e.preventDefault();

            const $btn = $(this);
            const eventId = $btn.data('event-id');
            const action = $btn.data('action'); // "increment" or "decrement"
            const $input = $('#qty-' + eventId);

            const url = action === 'increment'
                ? '/Customer/Cart/IncrementEventCartCount'
                : '/Customer/Cart/DecrementEventCartCount';

            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    EventId: eventId,
                    Count: 1
                },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        let currentQty = parseInt($input.val());
                        $input.val(action === 'increment' ? currentQty + 1 : currentQty - 1);

                        updateTotal();
                    } else {
                        alert(response.message);
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/Identity/Account/Login';
                    } else {
                        alert('حدث خطأ أثناء تحديث الكمية.');
                    }
                }
            });
        });

        function updateTotal() {
            let total = 0;
            $('.cart-item').each(function () {
                const price = parseFloat($(this).data('price'));
                const qty = parseInt($(this).find('.qty-input').val());
                total += price * qty;
            });

            $('#cart-total').text(total.toLocaleString(undefined, {
                style: 'currency',
                currency: 'USD'
            }));
        }
    });
</script>

<script>
    $(document).ready(function () {
        $('.delete-cart-item').on('click', function (e) {
            e.preventDefault();

            const eventId = $(this).data('event-id');

            if (!confirm('Are you sure you want to remove this item from your cart?')) {
                return;
            }

            $.ajax({
                url: '/Customer/Cart/Delete',
                type: 'POST',
                data: {
                    EventId: eventId
                },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload(); // أو ممكن تمسحي العنصر من DOM
                    } else {
                        alert(response.message || 'Something went wrong.');
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/Identity/Account/Login';
                    } else {
                        alert('حدث خطأ أثناء حذف العنصر من السلة.');
                    }
                }
            });
        });
    });
</script>
